/* File:   main.c
 * Author: Bryan
 * Created on January 21, 2016, 10:21 PM
 * Description: 
 */

/* Includes */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "main.h"
#include "glcd.h"
#include "font5x7.h"
#include <math.h>

//#define DEBUG_I2C
#define GLCD

#ifndef DEBUG
#define DEBUG
#endif

const char romFont[]={
0xf0,0x90,0x90,0x90,0xf0,0x20,0x60,0x20,0x20,0x70,0xf0,0x10,0xf0,0x80,0xf0,0xf0,0x10,0xf0,0x10,0xf0,0x90,0x90,0xf0,0x10,0x10,0xf0,0x80,0xf0,0x10,0xf0,0xf0,0x80,0xf0
,0x90,0xf0,0xf0,0x10,0x20,0x40,0x40,0xf0,0x90,0xf0,0x90,0xf0,0xf0,0x90,0xf0,0x10,0xf0,0xf0,0x90,0xf0,0x90,0x90,0xe0,0x90,0xe0,0x90,0xe0,0xf0,0x80,0x80,0x80,0xf0
,0xe0,0x90,0x90,0x90,0xe0,0xf0,0x80,0xf0,0x80,0xf0,0xf0,0x80,0xf0,0x80,0x80};
const int romFont_size=80;

const char romChip8[]={
0x00,0xe0,0xa2,0x48,0x60,0x00,0x61,0x1e,0x62,0x00,0xd2,0x02,0xd2,0x12,0x72,0x08,0x32,0x40,0x12,0x0a,0x60,0x00,0x61,0x3e,0x62,0x02,0xa2,0x4a,0xd0,0x2e,0xd1,0x2e,0x72
,0x0e,0xd0,0x2e,0xd1,0x2e,0xa2,0x58,0x60,0x0b,0x61,0x08,0xd0,0x1f,0x70,0x0a,0xa2,0x67,0xd0,0x1f,0x70,0x0a,0xa2,0x76,0xd0,0x1f,0x70,0x03,0xa2,0x85,0xd0,0x1f,0x70
,0x0a,0xa2,0x94,0xd0,0x1f,0x12,0x46,0xff,0xff,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xc0,0xff,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80
,0x80,0x80,0x80,0x80,0x80,0xff,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0xff,0x81,0x81,0x81,0x81,0x81,0x81,0x81,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80
,0x80,0x80,0x80,0x80,0xff,0x81,0x81,0x81,0x81,0x81,0x81,0xff,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0xff,0x81,0x81,0x81,0x81,0x81,0x81,0xff,0x81,0x81,0x81,0x81,0x81
,0x81,0xff,0xff};
const int romChip8_size=164;

const char romSctest[]={
0x12,0x12,0x20,0x54,0x72,0x6f,0x6e,0x69,0x78,0x20,0x28,0x63,0x29,0x20,0x32,0x30,0x31,0x30,0x00,0xe0,0x3f,0x00,0x13,0xe2,0x3e,0x00,0x13,0xe2,0x3d,0x00,0x13,0xe2,0x3c
,0x00,0x13,0xe2,0x3b,0x00,0x13,0xe2,0x3a,0x00,0x13,0xe2,0x39,0x00,0x13,0xe2,0x38,0x00,0x13,0xe2,0x37,0x00,0x13,0xe2,0x36,0x00,0x13,0xe2,0x35,0x00,0x13,0xe2,0x34
,0x00,0x13,0xe2,0x33,0x00,0x13,0xe2,0x32,0x00,0x13,0xe2,0x31,0x00,0x13,0xe2,0x30,0x00,0x13,0xe2,0x60,0x00,0x61,0x01,0x62,0x02,0x63,0x03,0x64,0x04,0x65,0x05,0x66
,0x06,0x67,0x07,0x68,0x08,0x69,0x09,0x6a,0x0a,0x6b,0x0b,0x6c,0x0c,0x6d,0x0d,0x6e,0x0e,0x6f,0x0f,0xa4,0x78,0xff,0x65,0x3f,0x00,0x13,0xf8,0x3e,0x00,0x13,0xf8,0x3d
,0x00,0x13,0xf8,0x3c,0x00,0x13,0xf8,0x3b,0x00,0x13,0xf8,0x3a,0x00,0x13,0xf8,0x39,0x00,0x13,0xf8,0x38,0x00,0x13,0xf8,0x37,0x00,0x13,0xf8,0x36,0x00,0x13,0xf8,0x35
,0x00,0x13,0xf8,0x34,0x00,0x13,0xf8,0x33,0x00,0x13,0xf8,0x32,0x00,0x13,0xf8,0x31,0x00,0x13,0xf8,0x30,0x00,0x13,0xf8,0x60,0x00,0xf0,0x29,0xf0,0x65,0x40,0x00,0x14
,0x02,0xa4,0x52,0x6e,0x7b,0xfe,0x33,0xf2,0x65,0x30,0x01,0x13,0xc6,0x31,0x02,0x13,0xc6,0x32,0x03,0x13,0xc6,0x6e,0x02,0x6f,0x00,0x60,0xfe,0x61,0x01,0x80,0x14,0x3f
,0x00,0x14,0x0c,0x6e,0x03,0x30,0xff,0x14,0x0c,0x6e,0x04,0x80,0x14,0x3f,0x01,0x14,0x0c,0x6e,0x05,0x30,0x00,0x14,0x0c,0x60,0x01,0x6e,0x06,0x6f,0x00,0x80,0x15,0x3f
,0x01,0x14,0x0c,0x6e,0x07,0x30,0x00,0x14,0x0c,0x6e,0x08,0x80,0x15,0x3f,0x00,0x14,0x0c,0x6e,0x09,0x30,0xff,0x14,0x0c,0x60,0x01,0x6e,0x0a,0x6f,0x00,0x80,0x17,0x3f
,0x01,0x14,0x0c,0x6e,0x0b,0x30,0x00,0x14,0x0c,0x6e,0x0c,0x60,0x01,0x61,0x00,0x80,0x17,0x3f,0x00,0x14,0x0c,0x6e,0x0d,0x30,0xff,0x14,0x0c,0x60,0xff,0x6e,0x0e,0x6f
,0x00,0x80,0x06,0x3f,0x01,0x14,0x0c,0x6e,0x0f,0x30,0x7f,0x14,0x0c,0x60,0x40,0x6e,0x10,0x80,0x06,0x3f,0x00,0x14,0x0c,0x6e,0x11,0x30,0x20,0x14,0x0c,0x6e,0x12,0x6f
,0x01,0x80,0x0e,0x3f,0x00,0x14,0x0c,0x6e,0x13,0x30,0x40,0x14,0x0c,0x60,0xfa,0x6e,0x14,0x80,0x0e,0x3f,0x01,0x14,0x0c,0x6e,0x15,0x30,0xf4,0x14,0x0c,0x61,0x7b,0x6e
,0x16,0x80,0x13,0x30,0x8f,0x14,0x0c,0xa4,0x88,0xf7,0x65,0xf7,0x75,0xa4,0x78,0xf7,0x65,0xf7,0x85,0x6e,0x17,0x37,0x07,0x14,0x0c,0x36,0x06,0x14,0x0c,0x35,0x05,0x14
,0x0c,0x34,0x04,0x14,0x0c,0x33,0x03,0x14,0x0c,0x32,0x02,0x14,0x0c,0x31,0x01,0x14,0x0c,0x30,0x00,0x14,0x0c,0x6e,0x18,0xaf,0xfe,0x60,0x02,0x6f,0x00,0xf0,0x1e,0x3f
,0x01,0x14,0x0c,0x14,0x90,0x24,0x12,0x70,0x0a,0x62,0x0b,0xf2,0x29,0xd0,0x15,0x70,0x05,0x62,0x0c,0xf2,0x29,0xd0,0x15,0x72,0x01,0xf2,0x29,0x70,0x05,0xd0,0x15,0x14
,0x50,0x24,0x12,0x70,0x0a,0xa4,0x64,0xd0,0x15,0x70,0x06,0xa4,0x69,0xd0,0x15,0x70,0x06,0xa4,0x64,0xd0,0x15,0x14,0x50,0x24,0x12,0x70,0x0a,0xa4,0x5a,0xd0,0x15,0x14
,0x50,0x24,0x12,0x70,0x0a,0xa4,0x55,0xd0,0x15,0x14,0x50,0x24,0x12,0x24,0x32,0x14,0x50,0x60,0x00,0x61,0x00,0xa4,0x5f,0xd0,0x15,0x70,0x05,0xa4,0x6e,0xd0,0x15,0x70
,0x06,0xd0,0x15,0xa4,0x5a,0x70,0x06,0xd0,0x15,0xa4,0x6e,0x70,0x05,0xd0,0x15,0x00,0xee,0x84,0x00,0x74,0x0a,0x85,0x10,0xa4,0x52,0xfe,0x33,0xf2,0x65,0xf0,0x29,0xd4
,0x55,0x74,0x06,0xf1,0x29,0xd4,0x55,0x74,0x06,0xf2,0x29,0xd4,0x55,0x00,0xee,0x14,0x50,0x00,0x00,0x00,0x10,0x30,0x10,0x10,0x10,0xf0,0x90,0x90,0x90,0xf0,0xf0,0x80
,0xf0,0x80,0xf0,0xf8,0x20,0x20,0x20,0xf8,0x88,0xc8,0xa8,0x98,0x88,0xe0,0x90,0xe0,0x90,0x88,0x90,0xa0,0xc0,0xa0,0x90,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x02,0x03,0x04,0x05,0x06,0x07,0x60,0x00,0x61,0x00,0xf0,0x29,0xd0,0x15,0x70,0x05,0xa4,0x73,0xd0,0x15,0x14,0x50,0x00};
const int romSctest_size=673;

const char romMaze[]={
0xa2,0x1e,0xc2,0x01,0x32,0x01,0xa2,0x1a,0xd0,0x14,0x70,0x04,0x30,0x40,0x12,0x00,0x60,0x00,0x71,0x04,0x31,0x20,0x12,0x00,0x12,0x18,0x80,0x40,0x20,0x10,0x20,0x40,0x80
,0x10,0x00};
const int romMaze_size=35;

const char romPong[]={
0x6a,0x02,0x6b,0x0c,0x6c,0x3f,0x6d,0x0c,0xa2,0xea,0xda,0xb6,0xdc,0xd6,0x6e,0x00,0x22,0xd4,0x66,0x03,0x68,0x02,0x60,0x60,0xf0,0x15,0xf0,0x07,0x30,0x00,0x12,0x1a,0xc7
,0x17,0x77,0x08,0x69,0xff,0xa2,0xf0,0xd6,0x71,0xa2,0xea,0xda,0xb6,0xdc,0xd6,0x60,0x01,0xe0,0xa1,0x7b,0xfe,0x60,0x04,0xe0,0xa1,0x7b,0x02,0x60,0x1f,0x8b,0x02,0xda
,0xb6,0x60,0x0c,0xe0,0xa1,0x7d,0xfe,0x60,0x0d,0xe0,0xa1,0x7d,0x02,0x60,0x1f,0x8d,0x02,0xdc,0xd6,0xa2,0xf0,0xd6,0x71,0x86,0x84,0x87,0x94,0x60,0x3f,0x86,0x02,0x61
,0x1f,0x87,0x12,0x46,0x02,0x12,0x78,0x46,0x3f,0x12,0x82,0x47,0x1f,0x69,0xff,0x47,0x00,0x69,0x01,0xd6,0x71,0x12,0x2a,0x68,0x02,0x63,0x01,0x80,0x70,0x80,0xb5,0x12
,0x8a,0x68,0xfe,0x63,0x0a,0x80,0x70,0x80,0xd5,0x3f,0x01,0x12,0xa2,0x61,0x02,0x80,0x15,0x3f,0x01,0x12,0xba,0x80,0x15,0x3f,0x01,0x12,0xc8,0x80,0x15,0x3f,0x01,0x12
,0xc2,0x60,0x20,0xf0,0x18,0x22,0xd4,0x8e,0x34,0x22,0xd4,0x66,0x3e,0x33,0x01,0x66,0x03,0x68,0xfe,0x33,0x01,0x68,0x02,0x12,0x16,0x79,0xff,0x49,0xfe,0x69,0xff,0x12
,0xc8,0x79,0x01,0x49,0x02,0x69,0x01,0x60,0x04,0xf0,0x18,0x76,0x01,0x46,0x40,0x76,0xfe,0x12,0x6c,0xa2,0xf2,0xfe,0x33,0xf2,0x65,0xf1,0x29,0x64,0x14,0x65,0x00,0xd4
,0x55,0x74,0x15,0xf2,0x29,0xd4,0x55,0x00,0xee,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x00,0x00,0x00};
const int romPong_size=247;

/* Debug write buffer */
static char debug [60];

/* Define shorthanded named types */
typedef unsigned char byte;
typedef unsigned short uint16;
typedef signed short int16;
typedef unsigned long uint32;
typedef unsigned long long uint64;
typedef signed long long int64;
typedef signed long int32;
//typedef void __attribute__((__interrupt__, __shadow__)) (_interrupt) (void);

/* Empty debug function */
void empty(char * x, ...) { }

const char *byte_to_binary(int x)
{
    static char b[9];
    b[0] = '\0';

    int z;
    for (z = 128; z > 0; z >>= 1)
    {
        strcat(b, ((x & z) == z) ? "1" : "0");
    }

    return b;
}

/* Causes a loop-based delay */
void delay_routine(void)
{
    __delay_ms(200);
}

#ifdef DEBUG
#if defined(GLCD)
#define DEBUG_WRITE(format, args...) \
    sprintf(debug, format , ##args); \
    GLCD_WRITE(debug)
#else
#define DEBUG_WRITE(format, args...) printf(format , ##args)
#endif
#else
#define DEBUG_WRITE(format, args...) empty(format, ##args);
#endif //DEBUG

#if defined(DEBUG_I2C)
#define I2CDebug(x, args...) \
    DEBUG_WRITE(x , ##args); \
    delay_routine()
#else
    #define I2CDebug(x, args...) empty(x , ##args)
#endif // DEBUG_I2C

void I2CIdleWait(void)
{
    while (I2C1CON & 0x1F);
    while (I2C1STATbits.TRSTAT);
}

void I2CStart(void)
{
    I2CIdleWait();
    I2C1CONbits.SEN = 1;
    while (I2C1CONbits.SEN);
    I2CDebug("Start");
}

void I2CStop(void)
{
    I2CIdleWait();
    I2C1CONbits.PEN = 1; // Initiate Stop condition on SDAx and SCLx
    while(I2C1CONbits.PEN); // bit = 0 --- Stop condition not in progress
    I2CDebug("Stop");
}

void I2CRestart(void)
{
    I2CIdleWait();
    I2C1CONbits.RSEN = 1; // Initiate Repeated Start condition on SDAx
    while(I2C1CONbits.RSEN); // bit = 0 --- Repeated Start condition not in
    I2CDebug("Restart");
}

void I2CAck(void)
{
    I2CIdleWait();
    I2C1CONbits.ACKDT = 0; // 0 = Send ACK during Acknowledge
    I2C1CONbits.ACKEN = 1; // 1 = Initiate Acknowledge sequence on
    while(I2C1CONbits.ACKEN); // bit = 0 --- Acknowledge sequence not in
    I2CDebug("Ack");
}

void I2CAckWait(void)
{
    I2CDebug("Ack Wait");
    while (I2C1STATbits.TRSTAT & I2C1STATbits.ACKSTAT);
}

void I2CNackWait(void)
{
    I2CDebug("Nack Wait");
    while (I2C1STATbits.TRSTAT & !I2C1STATbits.ACKSTAT);
}

void I2CNack(void) // Acknowledge Data bit
{
    I2CIdleWait();
    I2C1CONbits.ACKDT = 1; // 1 = Send NACK during Acknowledge
    I2C1CONbits.ACKEN = 1; // 1 = Initiate Acknowledge sequence on
    while(I2C1CONbits.ACKEN); // bit = 0 --- Acknowledge sequence not in
    I2CDebug("Nack");
}

void I2CInit(void)
{
    I2C1BRG = 34; // Baud Rate Generator
    I2C1CONbits.I2CEN = 1; // 0 = Disables the I2Cx module. All I2C pins
    I2C1CONbits.DISSLW = 1; // 0 = Slew rate control disabled
    I2CDebug("I2C Init");
}

void I2CBusIdleWait(void)
{
    while (I2C1STATbits.TRSTAT);
}

byte I2CReadByte(void)
{
    byte read = 0;
    I2C1CONbits.RCEN = 1;
    while (I2C1CONbits.RCEN & !I2C1STATbits.RBF) ;
    
    if (I2C1STATbits.BCL)
    {
        DEBUG_WRITE("R: Bus Coll.");
        while (1) { }
    }
    
    if (I2C1STATbits.I2COV)
    {
        DEBUG_WRITE("Overflow in RCV");
        while (1) { }
    }
    
    I2CIdleWait();
    read = (byte)(I2C1RCV & 0xFF);
    I2CDebug("R: 0x%02x", read);
    return read;
}

void I2CWriteByte(byte byte)
{
    if (I2C1STATbits.BCL)
    {
        DEBUG_WRITE("W: Bus Coll.");
        while (1) { }
    }
    
    I2C1TRN = byte;
    while (I2C1STATbits.TBF);
    I2CIdleWait();
    I2CAckWait();
    I2CDebug("W: 0x%02x", byte);
}

#define BlockSelect(x) x >= 0x8000 ? 1 : 0

byte __inline__ EEPROMGetControlByte(uint16 eepromAddress, uint16 slaveAddress, byte readMode)
{
    return (0xA << 4 | ((BlockSelect(eepromAddress) & 1) << 3) | ((slaveAddress & 3) << 1) | (readMode & 1));
}

void EEPROMWriteControlByte(uint16 eepromAddress, uint16 slaveAddress, byte readMode)
{
    byte c = EEPROMGetControlByte(eepromAddress, slaveAddress, readMode);
    I2CWriteByte(c);
}

void EEPROMWriteAddressBytes(uint16 eepromAddress)
{
    /* High */
    I2CWriteByte((eepromAddress >> 8) & 0xFF);
    
    /* Low */
    I2CWriteByte(eepromAddress & 0xFF);
}

void EEPROMReadBytes(
    byte * const buffer,
    int count,
    uint16 slaveAddress, 
    uint16 eepromAddress)
{
    int i = 0;
    
    I2C1ADD = slaveAddress;
        
    I2CStart();
    
    EEPROMWriteControlByte(eepromAddress, slaveAddress, 0);    
    EEPROMWriteAddressBytes(eepromAddress);
    
    I2CStart();
    
    EEPROMWriteControlByte(eepromAddress, slaveAddress, 1);
    
    if (count > 1)
    {
        for (i = 0; i < count && i < 64; i++)
        {
            *(buffer + i) = I2CReadByte();

            if ((i + 1) < count)
            {
                I2CAck();
            }
            else
            {
                I2CNack();
            }
        }
    }
    else
    {
        *buffer = I2CReadByte();
        I2CNack();
    }
    
    I2CStop();
}

void EEPROMWriteBytes(
    const byte * buffer,
    int count,
    uint16 slaveAddress, 
    uint16 eepromAddress)
{
    int i = 0;
    
    I2C1ADD = slaveAddress;
        
    I2CStart();
    
    EEPROMWriteControlByte(eepromAddress, slaveAddress, 0);    
    EEPROMWriteAddressBytes(eepromAddress);
    
    if (count > 1)
    {
        for (i = 0; i < count && i < 64; i++)
        {
           I2CWriteByte(*(buffer + i));
        }
    }
    else
    {
        I2CWriteByte(*buffer);
    }
    
    
    I2CStop();
    
    __delay_ms(5);
}

#define PAGE_MAX_SIZE 64

uint16 EEPROMFlashRom(char * name, const byte * buffer, const uint16 size, const uint16 address)
{
    int i = 0;
    uint16 cAddress = address;
    uint16 cOffset = 0;
    uint16 cSize = size;
    
    DEBUG_WRITE("FL: %s", name);
    
    for (i = 0; i < size; i++)
    {
            EEPROMWriteBytes((buffer + cOffset), 1, 0, cAddress);
            cAddress++;
            cOffset++;
            cSize--;
    }
    
        /* Verify byte by byte*/
    DEBUG_WRITE("Verify...");
    byte read [1];
    for (i = 0; i < size; i++)
    {
        EEPROMReadBytes(&read[0], 1, 0, address + i);
        if (*(buffer + i) != read[0])
        {
            DEBUG_WRITE("%04X %02X %02X %02X", address + i, read[0], i, *(buffer + i));
            while (1) {}
        }
    }
    
    DEBUG_WRITE("Write Done");
    
    return size;
}
#define ROM_ARG(x) (byte *)&rom##x
#define ROM_FLASH(x) address += EEPROMFlashRom(#x, ROM_ARG(x), rom##x##_size, address);

/* Main program entry point */
int main(void) 
{
    uint16 address = 0;
    
    /* Init the LCD and setup text write mode */
    #if defined(GLCD)
        glcd_init();
        GLCD_TEXT_INIT();
        glcd_clear_buffer();
    #endif

    DEBUG_WRITE("Start");
    
    I2CInit();
    
    ROM_FLASH(Font);
    ROM_FLASH(Chip8);
    ROM_FLASH(Sctest);
    ROM_FLASH(Maze);
    ROM_FLASH(Pong);
    
    DEBUG_WRITE("ALL DONE");
    
    while (1)
    {
    }
   
    return 0;
}
